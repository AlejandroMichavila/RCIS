<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCIS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
        /* ============================================================================
           rcis DESIGN SYSTEM - COLORES Y TIPOGRAF√çA
           ============================================================================ */
        :root {
            /* Paleta rcis */
            --rcis-blue: #004481;
            --rcis-light-blue: #1464A0;
            --rcis-medium-blue: #2DCCCD;
            --rcis-aqua: #2DCCCD;
            --rcis-dark-blue: #043263;
            --rcis-navy: #072146;
            
            /* Colores complementarios */
            --rcis-white: #FFFFFF;
            --rcis-light-gray: #F4F4F6;
            --rcis-medium-gray: #BDBDBD;
            --rcis-dark-gray: #666666;
            --rcis-text-gray: #121212;
            
            /* Estados */
            --rcis-success: #2ECC40;
            --rcis-warning: #FF851B;
            --rcis-error: #DC3545;
            
            /* Sombras rcis */
            --shadow-light: 0 2px 8px rgba(4, 68, 129, 0.1);
            --shadow-medium: 0 4px 16px rgba(4, 68, 129, 0.15);
            --shadow-heavy: 0 8px 24px rgba(4, 68, 129, 0.2);
            
            /* Transiciones */
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
        }

        /* Reset y base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Benton Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--rcis-light-gray) 0%, #E8F4F8 100%);
            color: var(--rcis-text-gray);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ============================================================================
           LAYOUT PRINCIPAL
           ============================================================================ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Header principal */
        h1 {
            font-size: 3rem;
            font-weight: 300;
            color: var(--rcis-blue);
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        h1::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--rcis-blue), var(--rcis-aqua));
            margin: 1rem auto;
            border-radius: 2px;
        }

        /* ============================================================================
           SECCI√ìN DE CONFIGURACI√ìN
           ============================================================================ */
        .config-section {
            background: var(--rcis-white);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(4, 68, 129, 0.1);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .config-header h3 {
            font-size: 1.5rem;
            color: var(--rcis-blue);
            font-weight: 400;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .config-header p {
            color: var(--rcis-dark-gray);
            font-size: 0.95rem;
        }

        /* Toggle de unidades */
        .units-toggle {
            display: flex;
            background: var(--rcis-light-gray);
            border-radius: 8px;
            padding: 4px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .units-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--rcis-dark-gray);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .units-btn.active {
            background: var(--rcis-white);
            color: var(--rcis-blue);
            box-shadow: var(--shadow-light);
            transform: translateY(-1px);
        }

        .units-btn:hover:not(.active) {
            color: var(--rcis-blue);
        }

        /* Grid de configuraci√≥n */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .config-item label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--rcis-blue);
        }

        .config-item input {
            padding: 0.875rem;
            border: 2px solid var(--rcis-light-gray);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--rcis-white);
            transition: all var(--transition-fast);
            color: var(--rcis-text-gray);
        }

        .config-item input:focus {
            outline: none;
            border-color: var(--rcis-aqua);
            box-shadow: 0 0 0 3px rgba(45, 204, 205, 0.1);
        }

        .config-item input:hover:not(:focus) {
            border-color: var(--rcis-medium-gray);
        }

        /* Secci√≥n de recalcular */
        .recalculate-section {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        /* ============================================================================
           √ÅREA DE CARGA
           ============================================================================ */
        .upload-area {
            background: var(--rcis-white);
            border: 3px dashed var(--rcis-light-blue);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-medium);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(45, 204, 205, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            border-color: var(--rcis-aqua);
            background: rgba(45, 204, 205, 0.02);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .upload-area.dragover {
            border-color: var(--rcis-aqua);
            background: rgba(45, 204, 205, 0.05);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            filter: grayscale(1);
            transition: filter var(--transition-medium);
        }

        .upload-area:hover .upload-icon {
            filter: grayscale(0);
        }

        .upload-text {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--rcis-blue);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: var(--rcis-dark-gray);
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        /* ============================================================================
           BOTONES
           ============================================================================ */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transition: all 0.4s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-recalculate {
            background: linear-gradient(135deg, var(--rcis-blue), var(--rcis-light-blue));
            color: var(--rcis-white);
            box-shadow: var(--shadow-light);
        }

        .btn-recalculate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-recalculate:disabled {
            background: var(--rcis-medium-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-download {
            background: linear-gradient(135deg, var(--rcis-aqua), var(--rcis-medium-blue));
            color: var(--rcis-white);
            box-shadow: var(--shadow-light);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* ============================================================================
           LOADING Y ESTADOS
           ============================================================================ */
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.25rem;
            color: var(--rcis-blue);
            background: var(--rcis-white);
            border-radius: 16px;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--rcis-aqua), var(--rcis-blue), var(--rcis-aqua));
            animation: loading-bar 1.5s infinite;
        }

        @keyframes loading-bar {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Errores */
        .error {
            background: linear-gradient(135deg, #FFE6E6, #FFD6D6);
            color: var(--rcis-error);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(220, 53, 69, 0.2);
            margin: 1rem 0;
            font-weight: 500;
            box-shadow: var(--shadow-light);
        }

        /* ============================================================================
           SECCI√ìN DE RESULTADOS
           ============================================================================ */
        .result-container {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sheet-info {
            background: var(--rcis-white);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--rcis-aqua);
        }

        .sheet-info h3 {
            color: var(--rcis-blue);
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .download-section {
            background: linear-gradient(135deg, var(--rcis-white), #F8FBFF);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(45, 204, 205, 0.1);
        }

        .download-section h3 {
            color: var(--rcis-blue);
            margin-bottom: 0.5rem;
            font-weight: 400;
        }

        .download-section p {
            color: var(--rcis-dark-gray);
            margin-bottom: 1.5rem;
        }

        /* ============================================================================
           NAVEGACI√ìN DE TABS
           ============================================================================ */
        .tabs-nav {
            display: flex;
            background: var(--rcis-white);
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
            overflow-x: auto;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--rcis-dark-gray);
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--rcis-blue), var(--rcis-light-blue));
            color: var(--rcis-white);
            box-shadow: var(--shadow-light);
        }

        .tab-btn:hover:not(.active) {
            background: var(--rcis-light-gray);
            color: var(--rcis-blue);
        }

        /* ============================================================================
           TABLA DE DATOS
           ============================================================================ */
        .content-area {
            background: var(--rcis-white);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: var(--shadow-light);
            overflow: hidden;
        }

        .table-wrapper {
            overflow: auto;
            max-height: 80vh;
            border-radius: 12px;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: var(--rcis-white);
        }

        .excel-table th,
        .excel-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--rcis-light-gray);
            border-right: 1px solid var(--rcis-light-gray);
        }

        .excel-table th {
            background: linear-gradient(135deg, var(--rcis-blue), var(--rcis-light-blue));
            color: var(--rcis-white);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .excel-table tr:nth-child(even) {
            background: rgba(45, 204, 205, 0.02);
        }

        .excel-table tr:hover {
            background: rgba(45, 204, 205, 0.05);
        }

        .excel-table td:first-child {
            font-weight: 500;
            color: var(--rcis-blue);
            background: rgba(4, 68, 129, 0.02);
        }

        /* Estilo especial para matriz de transici√≥n */
        .transition-matrix .excel-table th {
            background: linear-gradient(135deg, var(--rcis-warning), #FF6B35);
        }

        .transition-matrix .excel-table td:first-child {
            color: var(--rcis-warning);
            background: rgba(255, 133, 27, 0.05);
        }

        /* ============================================================================
           RESPONSIVE DESIGN
           ============================================================================ */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 2.5rem;
            }

            .config-header {
                flex-direction: column;
                align-items: stretch;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .units-toggle {
                align-self: stretch;
            }

            .excel-table th,
            .excel-table td {
                padding: 0.75rem;
            }

            .tabs-nav {
                flex-wrap: wrap;
            }

            .tab-btn {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }

            .config-section,
            .sheet-info,
            .download-section,
            .content-area {
                padding: 1.5rem;
            }

            .btn {
                padding: 0.875rem 1.5rem;
                font-size: 0.95rem;
            }
        }

        /* ============================================================================
           MEJORAS DE ACCESIBILIDAD
           ============================================================================ */
        .btn:focus,
        input:focus,
        .tab-btn:focus {
            outline: 3px solid rgba(45, 204, 205, 0.3);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Estados de hover mejorados */
        @media (hover: hover) {
            .config-item input:hover {
                box-shadow: 0 2px 8px rgba(4, 68, 129, 0.1);
            }
        }

        /* Contenido oculto de tabs */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>RCIS</h1>

        <div class="config-section">
            <div class="config-header">
                <div>
                    <h3>‚öôÔ∏è Configuraci√≥n de Ajustes</h3>
                    <p>Valores de poblaci√≥n real para el ajuste ponderado:</p>
                </div>
                <div class="units-toggle">
                    <button class="units-btn active" id="unidadesBtn">Unidades</button>
                    <button class="units-btn" id="milesBtn">Miles</button>
                </div>
            </div>
            <div class="config-grid" id="configGrid"></div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Arrastra tu archivo XLSX aqu√≠ o haz clic para seleccionar</div>
            <div class="upload-subtext">Solo archivos .xlsx permitidos</div>
        </div>

        <input type="file" id="fileInput" accept=".xlsx" />

        <div id="loading" class="loading" style="display: none;">
            Procesando archivo...
        </div>

        <div id="errorContainer"></div>

        <div id="resultContainer" class="result-container">
            <div class="sheet-info">
                <h3>Informaci√≥n Obtenida:</h3>
                <div id="sheetInfo"></div>
            </div>

            <div class="download-section" id="downloadSection" style="display: none;">
                <h3>Descargar Datos</h3>
                <p>Descarga todas las hojas procesadas como un archivo Excel</p>
                <button class="btn btn-download" id="downloadBtn">Descargar XLSX</button>
            </div>

            <!-- Navegaci√≥n de tabs -->
            <nav class="tabs-nav" id="tabsNav">
                <button class="tab-btn active" data-tab="adjusted">Datos ajustados por distribuci√≥n muestra</button>
                <button class="tab-btn" data-tab="matrix">Matriz de Transici√≥n</button>
                <button class="tab-btn" data-tab="final">Datos ajustados por matriz de transici√≥n</button>
            </nav>

            <!-- Contenido de cada tab -->
            <div class="content-area">
                <div id="adjustedContent" class="tab-content active"></div>
                <div id="matrixContent" class="tab-content transition-matrix"></div>
                <div id="finalContent" class="tab-content"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURACI√ìN
        // ============================================================================
        const CONFIG = {
            targetSheet: "RV EG23",
            markers: {
                start: "Pregunta 14R",
                end: "A QUIENES VOTAR√çAN A ALG√öN PARTIDO EN LAS PR√ìXIMAS ELECCIONES GENERALES"
            },
            rowOffsets: { startOffset: 3, endOffset: 3 },
            defaultAdjustments: [
                { label: "PP", value: 8091840 },
                { label: "PSOE", value: 7760970 },
                { label: "VOX", value: 3033744 },
                { label: "Sumar", value: 3014006 },
                { label: "ERC", value: 462883 },
                { label: "Junts", value: 392634 },
                { label: "EH Bildu", value: 333362 },
                { label: "EAJ-PNV", value: 275782 },
                { label: "BNG", value: 152327 },
                { label: "CCa", value: 114718 },
                { label: "UPN", value: 51764 },
                { label: "PACMA", value: 169237 },
                { label: "Otro partido", value: 606450 },
                { label: "En blanco", value: 199392 },
                { label: "Nulo", value: 261078 },
                { label: "No vot√≥", value: 1000000 },
                { label: "No ten√≠a edad", value: 500000 },
                { label: "No ten√≠a derecho a voto", value: 500000 },
                { label: "N.R.", value: 50000 },
                { label: "N.C.", value: 50000 }
            ]
        };

        // ============================================================================
        // CLASES - PRINCIPIO DE RESPONSABILIDAD √öNICA
        // ============================================================================

        // Maneja solo la validaci√≥n de archivos
        class FileValidator {
            static validate(file) {
                if (!file.name.toLowerCase().endsWith('.xlsx')) {
                    throw new Error('Por favor selecciona un archivo .xlsx v√°lido');
                }
                return true;
            }
        }

        // Maneja solo el procesamiento de datos
        class DataProcessor {
            constructor(adjustmentArray) {
                this.adjustmentArray = adjustmentArray;
            }

            process(workbook) {
                const sheet = this.getTargetSheet(workbook);
                const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                const markers = this.findMarkers(sheetData);
                const filteredData = this.extractDataRange(sheetData, markers);
                
                // Procesar datos ajustados por muestra
                const adjustedData = this.processData(filteredData);
                
                // Crear matriz de transici√≥n
                const transitionMatrix = this.createTransitionMatrix(adjustedData);
                
                // Aplicar matriz de transici√≥n
                const finalData = this.applyTransitionMatrix(adjustedData, transitionMatrix);
                
                return {
                    adjusted: adjustedData,
                    matrix: transitionMatrix,
                    final: finalData
                };
            }

            getTargetSheet(workbook) {
                if (!workbook.Sheets[CONFIG.targetSheet]) {
                    throw new Error(`La hoja "${CONFIG.targetSheet}" no se encontr√≥`);
                }
                return workbook.Sheets[CONFIG.targetSheet];
            }

            findMarkers(sheetData) {
                let startRowRef = -1, endRowRef = -1;

                for (let i = 0; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    
                    if (startRowRef === -1 && row.some(cell => cell?.toString().includes(CONFIG.markers.start))) {
                        startRowRef = i;
                    }
                    
                    if (startRowRef !== -1 && endRowRef === -1 && row.some(cell => cell?.toString().includes(CONFIG.markers.end))) {
                        endRowRef = i;
                        break;
                    }
                }

                return { startRowRef, endRowRef };
            }

            extractDataRange(sheetData, markers) {
                const { startRowRef, endRowRef } = markers;
                
                if (startRowRef === -1 || endRowRef === -1) {
                    return sheetData;
                }

                const actualStartRow = startRowRef + CONFIG.rowOffsets.startOffset;
                const actualEndRow = endRowRef - CONFIG.rowOffsets.endOffset;

                if (actualStartRow <= actualEndRow && actualStartRow >= 0 && actualEndRow < sheetData.length) {
                    return sheetData.slice(actualStartRow, actualEndRow + 1);
                }

                return sheetData;
            }

            processData(data) {
                const dataMatrix = this.createDataMatrix(data);
                const absoluteMatrix = this.convertToAbsolute(dataMatrix);
                const weights = this.calculateWeights(absoluteMatrix);
                return this.applyWeights(absoluteMatrix, weights);
            }

            createDataMatrix(data) {
                const matrix = data.map(row => [...row]);
                
                for (let row of matrix) {
                    if (row.some(cell => cell?.toString().includes('(N)'))) {
                        this.processNRow(row);
                        break;
                    }
                }
                
                return matrix;
            }

            processNRow(row) {
                for (let j = 0; j < row.length; j++) {
                    const cell = row[j];
                    if (cell && !cell.toString().includes('(N)') && !isNaN(parseFloat(cell))) {
                        row[j] = Math.round(parseFloat(cell));
                    }
                }
            }

            convertToAbsolute(matrix) {
                const result = matrix.map(row => [...row]);
                const lastRowIndex = result.length - 1;
                const nValues = result[lastRowIndex];

                for (let i = 1; i < lastRowIndex; i++) {
                    for (let j = 1; j < result[i].length; j++) {
                        const percentage = result[i][j];
                        const nValue = nValues[j];
                        result[i][j] = Math.round((percentage * nValue) / 100);
                    }
                }

                return result;
            }

            calculateWeights(matrix) {
                const totalAdjustment = this.adjustmentArray.reduce((sum, val) => sum + val, 0);
                const lastRowIndex = matrix.length - 1;
                const sampleTotals = matrix[lastRowIndex];
                const totalSample = sampleTotals[1];

                const weights = [];
                for (let col = 2; col < sampleTotals.length; col++) {
                    let sampleColumn = sampleTotals[col];
                    if (sampleColumn === 0) {
                        sampleColumn = 1;
                        alert(`Muestra inexistente en columna ${matrix[0][col]}. Se ajustar√° a 1 para continuar.`);
                    }
                    
                    const realColumn = this.adjustmentArray[col - 2];
                    const weight = realColumn / sampleColumn;
                    weights.push(weight);
                }

                return weights;
            }

            applyWeights(matrix, weights) {
                const result = [];

                // Headers sin columna TOTAL
                for (let i = 0; i < matrix.length - 1; i++) {
                    if (i === 0) {
                        result.push([matrix[i][0], ...matrix[i].slice(2)]);
                    } else {
                        result.push([matrix[i][0], ...matrix[i].slice(2)]);
                    }
                }

                // Aplicar ponderadores
                for (let i = 1; i < result.length; i++) {
                    for (let j = 1; j < result[i].length; j++) {
                        if (j - 1 < weights.length) {
                            result[i][j] = Math.round(result[i][j] * weights[j - 1]);
                        }
                    }
                }

                this.addTotalColumn(result);
                this.addNRow(result);
                return result;
            }

            addTotalColumn(matrix) {
                for (let i = 0; i < matrix.length; i++) {
                    if (i === 0) {
                        matrix[i].splice(1, 0, 'TOTAL');
                    } else {
                        const rowSum = matrix[i].slice(1).reduce((sum, val) => sum + (typeof val === 'number' ? val : 0), 0);
                        matrix[i].splice(1, 0, rowSum);
                    }
                }
            }

            addNRow(matrix) {
                const nRow = ['(N)'];
                for (let col = 1; col < matrix[0].length; col++) {
                    const colSum = matrix.slice(1).reduce((sum, row) => sum + row[col], 0);
                    nRow.push(colSum);
                }
                matrix.push(nRow);
            }

            // ============================================================================
            // MATRIZ DE TRANSICI√ìN
            // ============================================================================
            
            createTransitionMatrix(adjustedData) {
                // La matriz de transici√≥n muestra c√≥mo se redistribuyen los votos
                // Filas = voto anterior, Columnas = voto actual
                const parties = adjustedData[0].slice(1); // Obtener nombres de partidos (excluyendo primera columna y TOTAL si existe)
                const partyNames = parties.filter(party => party !== 'TOTAL');
                
                // Crear matriz identidad como base (cada partido se mantiene al 100%)
                const matrix = [['', ...partyNames]];
                
                // Para cada partido anterior (filas)
                partyNames.forEach(party => {
                    const row = [party];
                    
                    // Para cada partido actual (columnas)
                    partyNames.forEach(targetParty => {
                        if (party === targetParty) {
                            // Fidelidad del partido (70-90% t√≠picamente)
                            row.push(this.calculateFidelity(party));
                        } else {
                            // Transferencia hacia otros partidos (calculada)
                            row.push(this.calculateTransfer(party, targetParty));
                        }
                    });
                    
                    // Normalizar la fila para que sume 100%
                    this.normalizeMatrixRow(row);
                    matrix.push(row);
                });
                
                return matrix;
            }

            calculateFidelity(party) {
                // Fidelidades t√≠picas por partido (se pueden ajustar)
                const fidelityRates = {
                    'PP': 85, 'PSOE': 80, 'VOX': 90, 'Sumar': 75,
                    'ERC': 88, 'Junts': 86, 'EH Bildu': 92, 'EAJ-PNV': 89,
                    'BNG': 87, 'CCa': 83, 'UPN': 88, 'PACMA': 70,
                    'Otro partido': 40, 'En blanco': 30, 'Nulo': 25,
                    'No vot√≥': 20, 'No ten√≠a edad': 0, 'No ten√≠a derecho a voto': 0,
                    'N.R.': 10, 'N.C.': 10
                };
                
                return fidelityRates[party] || 50;
            }

            calculateTransfer(fromParty, toParty) {
                // Matriz de transferencias simplificada (se puede expandir)
                const transfers = {
                    'PP': { 'VOX': 8, 'PSOE': 2, 'No vot√≥': 3, 'En blanco': 2 },
                    'PSOE': { 'Sumar': 10, 'PP': 3, 'No vot√≥': 4, 'En blanco': 3 },
                    'VOX': { 'PP': 5, 'No vot√≥': 3, 'En blanco': 2 },
                    'Sumar': { 'PSOE': 12, 'No vot√≥': 8, 'En blanco': 5 },
                    'No vot√≥': { 'PP': 15, 'PSOE': 20, 'VOX': 10, 'Sumar': 15, 'En blanco': 20 }
                };
                
                return transfers[fromParty]?.[toParty] || 0;
            }

            normalizeMatrixRow(row) {
                // Normalizar fila para que sume 100% (excluyendo la primera columna que es el nombre)
                const values = row.slice(1);
                const sum = values.reduce((s, v) => s + v, 0);
                
                if (sum > 0) {
                    for (let i = 1; i < row.length; i++) {
                        row[i] = Math.round((row[i] / sum) * 100 * 100) / 100; // 2 decimales
                    }
                }
            }

            // ============================================================================
            // APLICAR MATRIZ DE TRANSICI√ìN
            // ============================================================================
            
            applyTransitionMatrix(adjustedData, transitionMatrix) {
                // Crear copia de los datos ajustados
                const result = adjustedData.map(row => [...row]);
                
                // Obtener los totales por columna de los datos ajustados (excluyendo fila N)
                const dataRows = result.slice(1, -1); // Excluir header y fila (N)
                const columnTotals = this.calculateColumnTotals(dataRows);
                
                // Aplicar transici√≥n a cada columna
                for (let colIndex = 1; colIndex < result[0].length; colIndex++) {
                    const columnName = result[0][colIndex];
                    if (columnName === 'TOTAL') continue;
                    
                    // Aplicar matriz de transici√≥n a esta columna
                    this.applyTransitionToColumn(result, colIndex, transitionMatrix, columnTotals[colIndex]);
                }
                
                // Recalcular totales
                this.recalculateTotals(result);
                
                return result;
            }

            calculateColumnTotals(dataRows) {
                const totals = {};
                
                if (dataRows.length > 0) {
                    for (let col = 1; col < dataRows[0].length; col++) {
                        totals[col] = dataRows.reduce((sum, row) => sum + (typeof row[col] === 'number' ? row[col] : 0), 0);
                    }
                }
                
                return totals;
            }

            applyTransitionToColumn(result, colIndex, transitionMatrix, originalTotal) {
                const columnName = result[0][colIndex];
                const matrixIndex = this.findMatrixPartyIndex(transitionMatrix, columnName);
                
                if (matrixIndex === -1) return; // Partido no encontrado en matriz
                
                // Obtener fila de transici√≥n para este partido
                const transitionRow = transitionMatrix[matrixIndex + 1]; // +1 porque la primera fila son headers
                
                // Aplicar transiciones
                const newValues = [];
                for (let rowIndex = 1; rowIndex < result.length - 1; rowIndex++) { // Excluir header y fila (N)
                    const currentValue = result[rowIndex][colIndex];
                    const partyName = result[rowIndex][0];
                    
                    // Buscar el factor de transici√≥n
                    const targetIndex = this.findMatrixPartyIndex(transitionMatrix, partyName);
                    let transitionFactor = 1; // Por defecto mantener el valor
                    
                    if (targetIndex !== -1) {
                        transitionFactor = transitionRow[targetIndex + 1] / 100; // Convertir porcentaje a decimal
                    }
                    
                    newValues[rowIndex] = Math.round(currentValue * transitionFactor);
                }
                
                // Aplicar los nuevos valores
                for (let rowIndex = 1; rowIndex < result.length - 1; rowIndex++) {
                    if (newValues[rowIndex] !== undefined) {
                        result[rowIndex][colIndex] = newValues[rowIndex];
                    }
                }
            }

            findMatrixPartyIndex(matrix, partyName) {
                for (let i = 1; i < matrix.length; i++) {
                    if (matrix[i][0] === partyName) {
                        return i - 1; // Retornar √≠ndice relativo (sin header)
                    }
                }
                return -1;
            }

            recalculateTotals(matrix) {
                // Recalcular columna TOTAL
                const totalColIndex = matrix[0].indexOf('TOTAL');
                if (totalColIndex !== -1) {
                    for (let row = 1; row < matrix.length - 1; row++) { // Excluir header y fila (N)
                        const rowSum = matrix[row].slice(1).reduce((sum, val) => {
                            return sum + (typeof val === 'number' && matrix[0][matrix[row].indexOf(val)] !== 'TOTAL' ? val : 0);
                        }, 0);
                        matrix[row][totalColIndex] = rowSum;
                    }
                }
                
                // Recalcular fila (N)
                const nRowIndex = matrix.length - 1;
                for (let col = 1; col < matrix[0].length; col++) {
                    const colSum = matrix.slice(1, -1).reduce((sum, row) => sum + (typeof row[col] === 'number' ? row[col] : 0), 0);
                    matrix[nRowIndex][col] = colSum;
                }
            }
        }

        // Maneja solo la interfaz de usuario
        class UIManager {
            constructor() {
                this.elements = {
                    fileInput: document.getElementById('fileInput'),
                    uploadArea: document.getElementById('uploadArea'),
                    loading: document.getElementById('loading'),
                    errorContainer: document.getElementById('errorContainer'),
                    resultContainer: document.getElementById('resultContainer'),
                    sheetInfo: document.getElementById('sheetInfo'),
                    adjustedContent: document.getElementById('adjustedContent'),
                    matrixContent: document.getElementById('matrixContent'),
                    finalContent: document.getElementById('finalContent'),
                    downloadSection: document.getElementById('downloadSection'),
                    downloadBtn: document.getElementById('downloadBtn'),
                    recalculateBtn: null // Se inicializar√° cuando se cree
                };
                
                this.setupTabs();
            }

            setupTabs() {
                const tabBtns = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetTab = btn.getAttribute('data-tab');
                        
                        // Remover active de todos
                        tabBtns.forEach(b => b.classList.remove('active'));
                        tabContents.forEach(c => c.classList.remove('active'));
                        
                        // Activar el seleccionado
                        btn.classList.add('active');
                        document.getElementById(targetTab + 'Content').classList.add('active');
                    });
                });
            }

            showError(message) {
                this.elements.errorContainer.innerHTML = `<div class="error">‚ùå ${message}</div>`;
                this.hideLoading();
                this.hideResults();
            }

            clearError() {
                this.elements.errorContainer.innerHTML = '';
            }

            showLoading() {
                this.clearError();
                this.elements.loading.style.display = 'block';
                this.hideResults();
            }

            hideLoading() {
                this.elements.loading.style.display = 'none';
            }

            showResults(processedData, info) {
                this.elements.sheetInfo.innerHTML = info;
                
                // Mostrar cada tipo de datos en su tab correspondiente
                this.elements.adjustedContent.innerHTML = this.generateTableHTML(processedData.adjusted);
                this.elements.matrixContent.innerHTML = this.generateTableHTML(processedData.matrix);
                this.elements.finalContent.innerHTML = this.generateTableHTML(processedData.final);
                
                this.elements.resultContainer.style.display = 'block';
                this.elements.downloadSection.style.display = 'block';
            }

            hideResults() {
                this.elements.resultContainer.style.display = 'none';
            }

            generateTableHTML(data) {
                if (!data || data.length === 0) {
                    return '<p style="color: #666; font-style: italic;">No hay datos para mostrar</p>';
                }

                const sheet = XLSX.utils.aoa_to_sheet(data);
                const html = XLSX.utils.sheet_to_html(sheet);
                const tableHtml = html.replace('<table>', '<table class="excel-table">');
                
                // Envolver la tabla en un contenedor con scroll horizontal
                return `<div class="table-wrapper">${tableHtml}</div>`;
            }

            enableRecalculateButton() {
                if (this.elements.recalculateBtn) {
                    this.elements.recalculateBtn.disabled = false;
                }
            }

            disableRecalculateButton() {
                if (this.elements.recalculateBtn) {
                    this.elements.recalculateBtn.disabled = true;
                }
            }
        }

        // Maneja solo la descarga de archivos
        class FileDownloader {
            static download(processedData, originalFileName) {
                try {
                    const wb = XLSX.utils.book_new();
                    
                    // A√±adir cada hoja al workbook
                    const adjustedWs = XLSX.utils.aoa_to_sheet(processedData.adjusted);
                    XLSX.utils.book_append_sheet(wb, adjustedWs, 'Datos ajustados muestra');
                    
                    const matrixWs = XLSX.utils.aoa_to_sheet(processedData.matrix);
                    XLSX.utils.book_append_sheet(wb, matrixWs, 'Matriz Transici√≥n');
                    
                    const finalWs = XLSX.utils.aoa_to_sheet(processedData.final);
                    XLSX.utils.book_append_sheet(wb, finalWs, 'Datos ajustados m.transici√≥n');

                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const baseFileName = originalFileName.replace(/\.[^/.]+$/, '') || 'rcis_datos';
                    const fileName = `${baseFileName}_procesado_${timestamp}.xlsx`;

                    XLSX.writeFile(wb, fileName);
                } catch (error) {
                    throw new Error('Error al generar el archivo: ' + error.message);
                }
            }
        }

        // Maneja la configuraci√≥n
        class ConfigManager {
            constructor() {
                this.isInThousands = false; // Por defecto en unidades
                this.onRecalculate = null; // Callback para recalcular
                this.setupConfigUI();
                this.setupUnitsToggle();
            }

            setupConfigUI() {
                const grid = document.getElementById('configGrid');
                CONFIG.defaultAdjustments.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'config-item';
                    div.innerHTML = `
                        <label>${item.label}</label>
                        <input type="number" id="adj_${index}" value="${this.convertToDisplayValue(item.value)}">
                    `;
                    grid.appendChild(div);
                });

                // A√±adir bot√≥n de recalcular
                this.addRecalculateButton(grid);
            }

            addRecalculateButton(grid) {
                const recalculateDiv = document.createElement('div');
                recalculateDiv.className = 'recalculate-section';
                recalculateDiv.innerHTML = `
                    <button class="btn btn-recalculate" id="recalculateBtn" disabled>
                         Recalcular
                    </button>
                `;
                grid.appendChild(recalculateDiv);

                // Configurar el event listener
                const recalculateBtn = document.getElementById('recalculateBtn');
                recalculateBtn.addEventListener('click', () => {
                    if (this.onRecalculate && !recalculateBtn.disabled) {
                        this.onRecalculate();
                    }
                });

                return recalculateBtn;
            }

            setupUnitsToggle() {
                const milesBtn = document.getElementById('milesBtn');
                const unidadesBtn = document.getElementById('unidadesBtn');

                milesBtn.addEventListener('click', () => {
                    if (!this.isInThousands) {
                        this.toggleUnits(true);
                        this.updateButtonStates(milesBtn, unidadesBtn);
                    }
                });

                unidadesBtn.addEventListener('click', () => {
                    if (this.isInThousands) {
                        this.toggleUnits(false);
                        this.updateButtonStates(unidadesBtn, milesBtn);
                    }
                });
            }

            updateButtonStates(activeBtn, inactiveBtn) {
                activeBtn.classList.add('active');
                inactiveBtn.classList.remove('active');
            }

            toggleUnits(toThousands) {
                CONFIG.defaultAdjustments.forEach((item, index) => {
                    const input = document.getElementById(`adj_${index}`);
                    const currentValue = parseInt(input.value) || 0;
                    
                    if (toThousands && !this.isInThousands) {
                        // Convertir de unidades a miles
                        input.value = Math.round(currentValue / 1000);
                    } else if (!toThousands && this.isInThousands) {
                        // Convertir de miles a unidades
                        input.value = currentValue * 1000;
                    }
                });
                
                this.isInThousands = toThousands;
            }

            convertToDisplayValue(value) {
                return this.isInThousands ? Math.round(value / 1000) : value;
            }

            getAdjustmentArray() {
                return CONFIG.defaultAdjustments.map((item, index) => {
                    const input = document.getElementById(`adj_${index}`);
                    const inputValue = parseInt(input.value) || 0;
                    
                    
                    return inputValue;
                });
            }

            setRecalculateCallback(callback) {
                this.onRecalculate = callback;
            }
        }

        // Clase principal - Orquestador (Single Responsibility: coordinar)
        class RCISApp {
            constructor() {
                this.ui = new UIManager();
                this.configManager = new ConfigManager();
                this.processedData = null;
                this.originalFileName = '';
                this.currentWorkbook = null; // Almacenar el workbook para recalcular
                this.setupEventListeners();
                this.setupRecalculate();
            }

            setupEventListeners() {
                // Drag and Drop
                this.ui.elements.uploadArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    this.ui.elements.uploadArea.classList.add('dragover');
                });

                this.ui.elements.uploadArea.addEventListener('dragleave', () => {
                    this.ui.elements.uploadArea.classList.remove('dragover');
                });

                this.ui.elements.uploadArea.addEventListener('drop', e => {
                    e.preventDefault();
                    this.ui.elements.uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        this.handleFile(e.dataTransfer.files[0]);
                    }
                });

                this.ui.elements.uploadArea.addEventListener('click', () => {
                    this.ui.elements.fileInput.click();
                });

                this.ui.elements.fileInput.addEventListener('change', e => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });

                this.ui.elements.downloadBtn.addEventListener('click', () => {
                    this.downloadFile();
                });
            }

            setupRecalculate() {
                this.configManager.setRecalculateCallback(() => {
                    this.recalculateData();
                });
                
                // Obtener referencia al bot√≥n de recalcular para el UIManager
                this.ui.elements.recalculateBtn = document.getElementById('recalculateBtn');
            }

            async handleFile(file) {
                try {
                    FileValidator.validate(file);
                    this.originalFileName = file.name;
                    this.ui.showLoading();

                    const arrayBuffer = await this.readFile(file);
                    const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                    
                    // Almacenar el workbook para futuros rec√°lculos
                    this.currentWorkbook = workbook;
                    
                    const adjustmentArray = this.configManager.getAdjustmentArray();
                    const processor = new DataProcessor(adjustmentArray);
                    const result = processor.process(workbook);

                    this.processedData = result;
                    const info = `<strong>Archivo procesado:</strong> ${file.name}<br><strong>Hoja:</strong> ${CONFIG.targetSheet}`;
                    
                    this.ui.hideLoading();
                    this.ui.showResults(result, info);
                    this.ui.enableRecalculateButton(); // Habilitar el bot√≥n de recalcular

                } catch (error) {
                    this.ui.showError(error.message);
                    this.ui.disableRecalculateButton(); // Deshabilitar el bot√≥n si hay error
                }
            }

            recalculateData() {
                if (!this.currentWorkbook) {
                    alert('No hay datos cargados para recalcular');
                    return;
                }

                try {
                    this.ui.showLoading();
                    
                    // Obtener los nuevos valores de ajuste
                    const adjustmentArray = this.configManager.getAdjustmentArray();
                    const processor = new DataProcessor(adjustmentArray);
                    const result = processor.process(this.currentWorkbook);

                    this.processedData = result;
                    const info = `<strong>üìÅ Archivo procesado:</strong> ${this.originalFileName}<br><strong>üìä Hoja:</strong> ${CONFIG.targetSheet}<br><strong>üîÑ Recalculado:</strong> Datos ajustados, matriz de transici√≥n y resultado final`;
                    
                    this.ui.hideLoading();
                    this.ui.showResults(result, info);

                } catch (error) {
                    this.ui.showError('Error al recalcular: ' + error.message);
                }
            }

            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Error al leer el archivo'));
                    reader.readAsArrayBuffer(file);
                });
            }

            downloadFile() {
                if (!this.processedData) {
                    alert('No hay datos para descargar');
                    return;
                }

                try {
                    FileDownloader.download(this.processedData, this.originalFileName);
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        // ============================================================================
        // INICIALIZACI√ìN
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            new RCISApp();
        });
    </script>
</body>

</html>

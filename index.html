<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCIS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background-color: #f9f9f9;
            border-color: #45a049;
        }

        .upload-area.dragover {
            background-color: #e8f5e8;
            border-color: #45a049;
        }

        #fileInput {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #999;
        }

        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 15px 10px 0 0;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn-download {
            background-color: #2196F3;
        }

        .btn-download:hover {
            background-color: #1976D2;
        }

        .result-container {
            margin-top: 30px;
            display: none;
        }

        .sheet-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .sheet-info h3 {
            margin: 0 0 10px 0;
            color: #2196F3;
        }

        .download-section {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .content-area {
            background-color: #fafafa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
            max-height: 500px;
            overflow: auto;
        }

        .excel-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .excel-table th,
        .excel-table td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
            min-width: 60px;
            max-width: 200px;
            word-wrap: break-word;
        }

        .excel-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        .excel-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .excel-table tr:hover {
            background-color: #f5f5f5;
        }

        .content-area pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä RCIS</h1>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Arrastra tu archivo XLSX aqu√≠ o haz clic para seleccionar</div>
            <div class="upload-subtext">Solo archivos .xlsx permitidos</div>
        </div>

        <input type="file" id="fileInput" accept=".xlsx" />

        <div id="loading" class="loading" style="display: none;">
            Procesando archivo...
        </div>

        <div id="errorContainer"></div>

        <div id="resultContainer" class="result-container">
            <div class="sheet-info">
                <h3>Informaci√≥n Obtenida:</h3>
                <div id="sheetInfo"></div>
            </div>

            <div class="download-section" id="downloadSection" style="display: none;">
                <h3>üì• Descargar Datos</h3>
                <p>Descarga los datos filtrados como un archivo Excel</p>
                <button class="btn btn-download" id="downloadBtn">‚¨áÔ∏è Descargar XLSX</button>
            </div>

            <div class="content-area">
                <div id="contentDisplay"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // RCIS - Sistema de Procesamiento de Datos Electorales
        // Versi√≥n optimizada con mejores pr√°cticas de JavaScript
        // ============================================================================

        class RCISProcessor {
            constructor() {
                this.initializeElements();
                this.initializeData();
                this.setupEventListeners();
                this.setupConfiguration();
            }

            // ========================================
            // CONFIGURACI√ìN E INICIALIZACI√ìN
            // ========================================

            initializeElements() {
                this.elements = {
                    fileInput: document.getElementById('fileInput'),
                    uploadArea: document.getElementById('uploadArea'),
                    loading: document.getElementById('loading'),
                    errorContainer: document.getElementById('errorContainer'),
                    resultContainer: document.getElementById('resultContainer'),
                    sheetInfo: document.getElementById('sheetInfo'),
                    contentDisplay: document.getElementById('contentDisplay'),
                    downloadSection: document.getElementById('downloadSection'),
                    downloadBtn: document.getElementById('downloadBtn')
                };
            }

            initializeData() {
                this.filteredData = null;
                this.originalFileName = '';
                this.processedResult = null;
            }

            setupConfiguration() {
                this.config = {
                    adjustmentArray: [
                        8091840, 7760970, 3033744, 3014006, 462883, 392634, 333362, 275782,
                        152327, 114718, 51764, 169237, 606450, 199392, 261078, 1000000,
                        500000, 500000, 50000, 50000
                    ],
                    targetSheet: "RV EG23",
                    markers: {
                        start: "Pregunta 14R",
                        end: "A QUIENES VOTAR√çAN A ALG√öN PARTIDO EN LAS PR√ìXIMAS ELECCIONES GENERALES"
                    },
                    rowOffsets: {
                        startOffset: 3, // filas despu√©s del marcador inicio
                        endOffset: 3    // filas antes del marcador final
                    }
                };
            }

            setupEventListeners() {
                // Drag and Drop
                this.elements.uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                this.elements.uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                this.elements.uploadArea.addEventListener('drop', this.handleDrop.bind(this));
                this.elements.uploadArea.addEventListener('click', () => this.elements.fileInput.click());

                // File input
                this.elements.fileInput.addEventListener('change', this.handleFileInputChange.bind(this));

                // Download button
                this.elements.downloadBtn.addEventListener('click', this.downloadExcel.bind(this));
            }

            // ========================================
            // MANEJO DE EVENTOS
            // ========================================

            handleDragOver(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.add('dragover');
            }

            handleDragLeave() {
                this.elements.uploadArea.classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFile(files[0]);
                }
            }

            handleFileInputChange(e) {
                if (e.target.files.length > 0) {
                    this.handleFile(e.target.files[0]);
                }
            }

            // ========================================
            // MANEJO DE ARCHIVOS Y VALIDACI√ìN
            // ========================================

            handleFile(file) {
                if (!this.validateFile(file)) return;

                this.originalFileName = file.name;
                this.showLoading();
                this.processFileAsync(file);
            }

            validateFile(file) {
                if (!file.name.toLowerCase().endsWith('.xlsx')) {
                    this.showError('Por favor selecciona un archivo .xlsx v√°lido');
                    return false;
                }
                return true;
            }

            async processFileAsync(file) {
                try {
                    const arrayBuffer = await this.readFileAsArrayBuffer(file);
                    const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });

                    const result = this.processWorkbook(workbook);
                    this.displayResults(result);

                } catch (error) {
                    this.showError('Error al procesar el archivo: ' + error.message);
                }
            }

            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('Error al leer el archivo'));
                    reader.readAsArrayBuffer(file);
                });
            }

            // ========================================
            // PROCESAMIENTO DE WORKBOOK
            // ========================================

            processWorkbook(workbook) {
                const sheetNames = workbook.SheetNames;

                if (sheetNames.length === 0) {
                    throw new Error('El archivo no contiene hojas de c√°lculo');
                }

                if (!sheetNames.includes(this.config.targetSheet)) {
                    throw new Error(`La hoja "${this.config.targetSheet}" no se encontr√≥. Hojas disponibles: ${sheetNames.join(', ')}`);
                }

                const targetSheet = workbook.Sheets[this.config.targetSheet];
                const sheetData = XLSX.utils.sheet_to_json(targetSheet, { header: 1, defval: '' });

                const markers = this.findMarkers(sheetData);
                const filteredData = this.extractDataRange(sheetData, markers);
                const processedData = this.processDataComplete(filteredData);

                return {
                    sheetNames,
                    sheetPosition: sheetNames.indexOf(this.config.targetSheet) + 1,
                    markers,
                    originalData: sheetData,
                    filteredData,
                    processedData,
                    targetSheet
                };
            }

            findMarkers(sheetData) {
                let startRowRef = -1;
                let endRowRef = -1;

                for (let i = 0; i < sheetData.length; i++) {
                    const row = sheetData[i];

                    if (startRowRef === -1) {
                        for (let j = 0; j < row.length; j++) {
                            if (row[j]?.toString().includes(this.config.markers.start)) {
                                startRowRef = i;
                                break;
                            }
                        }
                    }

                    if (startRowRef !== -1 && endRowRef === -1) {
                        for (let j = 0; j < row.length; j++) {
                            if (row[j]?.toString().includes(this.config.markers.end)) {
                                endRowRef = i;
                                break;
                            }
                        }
                    }
                }

                return { startRowRef, endRowRef };
            }

            extractDataRange(sheetData, markers) {
                const { startRowRef, endRowRef } = markers;

                if (startRowRef === -1 || endRowRef === -1) {
                    console.warn('Marcadores no encontrados, usando toda la hoja');
                    return sheetData;
                }

                const actualStartRow = startRowRef + this.config.rowOffsets.startOffset;
                const actualEndRow = endRowRef - this.config.rowOffsets.endOffset;

                if (actualStartRow <= actualEndRow && actualStartRow >= 0 && actualEndRow < sheetData.length) {
                    return sheetData.slice(actualStartRow, actualEndRow + 1);
                }

                console.warn('Rango calculado inv√°lido, usando toda la hoja');
                return sheetData;
            }

            // ========================================
            // PROCESAMIENTO DE DATOS PRINCIPAL
            // ========================================

            processDataComplete(data) {
                console.group('üîÑ INICIANDO PROCESAMIENTO COMPLETO');

                // Paso 1: Crear matriz de datos y procesar fila (N)
                const dataMatrix = this.createDataMatrix(data);
                console.log('‚úÖ Matriz de datos creada');
                console.table(dataMatrix);

                // Paso 2: Convertir porcentajes a valores absolutos
                const absoluteMatrix = this.convertPercentagesToAbsolute(dataMatrix);
                console.log('‚úÖ Convertido a valores absolutos');
                console.table(absoluteMatrix);

                // Paso 3: Calcular ponderadores
                const adjustmentResult = this.calculateWeights(absoluteMatrix);
                console.log('‚úÖ Ponderadores calculados:', adjustmentResult);

                // Paso 4: Aplicar ponderadores y generar matriz final
                const finalMatrix = this.applyWeightsToMatrix(absoluteMatrix, adjustmentResult.ponderadores);
                console.log('‚úÖ Matriz final generada');
                console.table(finalMatrix);

                console.groupEnd();

                return {
                    originalMatrix: dataMatrix,
                    absoluteMatrix,
                    adjustmentResult,
                    finalMatrix
                };
            }

            createDataMatrix(data) {
                const processedData = data.map(row => [...row]);

                // Buscar y procesar fila que contiene (N)
                for (let i = 0; i < processedData.length; i++) {
                    const row = processedData[i];
                    const hasNMarker = row.some(cell => cell?.toString().includes('(N)'));

                    if (hasNMarker) {
                        this.processNRow(processedData[i]);
                        console.log(`üìç Fila (N) procesada en √≠ndice ${i}`);
                        break;
                    }
                }

                return processedData;
            }

            processNRow(row) {
                for (let j = 0; j < row.length; j++) {
                    const cell = row[j];
                    if (cell == null || cell === '') continue;

                    const cellStr = cell.toString();
                    if (cellStr.includes('(N)')) continue;

                    // Procesar n√∫meros
                    if (!isNaN(cellStr) && !isNaN(parseFloat(cellStr))) {
                        row[j] = Math.round(parseFloat(cellStr)); //Ahora se redondea para que E-> 1 | E != 0
                    }
                    // Procesar texto con n√∫meros
                    else if (/[\d,.\s]+/.test(cellStr)) {
                        row[j] = cellStr.replace(/(\d+)[.,](\d+)/g, '$1');
                    }
                }
            }

            convertPercentagesToAbsolute(dataMatrix) {
                const result = dataMatrix.map(row => [...row]);
                const lastRowIndex = result.length - 1;
                const nValues = result[lastRowIndex];

                // Convertir porcentajes a absolutos (filas 1 a pen√∫ltima, columnas 1 en adelante)
                for (let i = 1; i < lastRowIndex; i++) {
                    for (let j = 1; j < result[i].length; j++) {
                        const percentage = result[i][j];
                        const nValue = nValues[j];
                        result[i][j] = Math.round((percentage * nValue) / 100);
                    }
                }

                return result;
            }

            calculateWeights(dataMatrix) {
                const totalAdjustment = this.config.adjustmentArray.reduce((sum, value) => sum + value, 0);
                const adjustmentArrayWithTotal = [totalAdjustment, ...this.config.adjustmentArray];

                const lastRowIndex = dataMatrix.length - 1;
                const sampleTotals = dataMatrix[lastRowIndex];
                const totalSample = sampleTotals[1];
                const totalReal = adjustmentArrayWithTotal[0];

                const ponderadores = [];

                // Calcular ponderadores para cada columna
                for (let col = 2; col < sampleTotals.length; col++) {
                    let sampleColumn = sampleTotals[col];
                    if (sampleColumn == 0) {
                        sampleColumn = 1;
                        Swal.fire({
                            title: 'Muestra inexistente',
                            html: `Pretendes ajustar una muestra inexistente en la columna <strong>${dataMatrix[0][col]}</strong><br><br>
               Si aceptas, se calcular√° ajustando a 1 para poder proceder con los dem√°s.<br>
               <em>Es imposible que se ajuste a la proporci√≥n real</em>`,
                            icon: 'warning',
                            showCancelButton: false,
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'Entiendo lo que significa',
                            
                        })
                    }
                    const realColumn = adjustmentArrayWithTotal[col - 1];
                    const ponderador = (realColumn / totalReal) / (sampleColumn / totalSample);

                    ponderadores.push(ponderador);
                    console.log(`üìä Columna ${col}: Muestra=${sampleColumn}, Real=${realColumn}, Ponderador=${ponderador.toFixed(6)}`);
                }

                return {
                    adjustmentArrayWithTotal,
                    ponderadores,
                    totalSample,
                    totalReal
                };
            }

            applyWeightsToMatrix(dataMatrix, ponderadores) {
                // Crear matriz sin √∫ltima fila (N) y sin segunda columna (TOTAL)
                const matrixCopy = [];

                for (let i = 0; i < dataMatrix.length - 1; i++) {
                    if (i === 0) {
                        // Headers: excluir segunda columna
                        matrixCopy.push([dataMatrix[i][0], ...dataMatrix[i].slice(2)]);
                    } else {
                        // Datos: excluir segunda columna
                        matrixCopy.push([dataMatrix[i][0], ...dataMatrix[i].slice(2)]);
                    }
                }

                // Aplicar ponderadores
                for (let i = 1; i < matrixCopy.length; i++) {
                    for (let j = 1; j < matrixCopy[i].length; j++) {
                        const ponderadorIndex = j - 1;
                        if (ponderadorIndex < ponderadores.length) {
                            matrixCopy[i][j] = Math.round(matrixCopy[i][j] * ponderadores[ponderadorIndex]);
                        }
                    }
                }

                // A√±adir columna TOTAL
                this.addTotalColumn(matrixCopy);

                // A√±adir fila (N)
                this.addNRow(matrixCopy);

                return matrixCopy;
            }

            // M√©todo corregido para a√±adir la columna TOTAL
            addTotalColumn(matrix) {
                for (let i = 0; i < matrix.length; i++) {
                    if (i === 0) {
                        // Header: insertar 'TOTAL' en posici√≥n 1
                        matrix[i].splice(1, 0, 'TOTAL');
                    } else {
                        // Datos: calcular suma ANTES de insertar la columna TOTAL
                        // Sumar desde la columna 1 en adelante (todas las columnas de datos actuales)
                        const rowSum = matrix[i].slice(1).reduce((sum, val) => sum + (typeof val === 'number' ? val : 0), 0);
                        // Insertar el total calculado en posici√≥n 1
                        matrix[i].splice(1, 0, rowSum);
                    }
                }
            }

            addNRow(matrix) {
                const nRow = ['(N)'];

                for (let col = 1; col < matrix[0].length; col++) {
                    const colSum = matrix.slice(1).reduce((sum, row) => sum + row[col], 0);
                    nRow.push(colSum);
                }

                matrix.push(nRow);
            }

            // ========================================
            // PRESENTACI√ìN DE RESULTADOS
            // ========================================

            displayResults(result) {
                this.filteredData = result.processedData.finalMatrix;
                this.processedResult = result;

                const infoHTML = this.generateInfoHTML(result);
                this.elements.sheetInfo.innerHTML = infoHTML;

                const tableHTML = this.generateTableHTML(this.filteredData);
                this.elements.contentDisplay.innerHTML = tableHTML;

                this.hideLoading();
                this.showResults();
            }

            generateInfoHTML(result) {
                const { sheetNames, sheetPosition, markers, processedData } = result;

                let html = `
            <strong>üìä Informaci√≥n del Procesamiento</strong><br>
            <strong>Hoja:</strong> ${this.config.targetSheet} (${sheetPosition}/${sheetNames.length})<br>
            <strong>Todas las hojas:</strong> ${sheetNames.join(', ')}<br>
        `;

                if (markers.startRowRef !== -1 && markers.endRowRef !== -1) {
                    html += `
                <strong>üéØ Marcadores encontrados:</strong><br>
                &nbsp;&nbsp;‚Ä¢ "${this.config.markers.start}" en fila ${markers.startRowRef + 1}<br>
                &nbsp;&nbsp;‚Ä¢ "${this.config.markers.end}" en fila ${markers.endRowRef + 1}<br>
            `;
                }

                if (processedData.adjustmentResult) {
                    html += `
                <strong>‚öñÔ∏è Ajustes aplicados:</strong><br>
                &nbsp;&nbsp;‚Ä¢ Total muestral: ${processedData.adjustmentResult.totalSample.toLocaleString()}<br>
                &nbsp;&nbsp;‚Ä¢ Total real: ${processedData.adjustmentResult.totalReal.toLocaleString()}<br>
                &nbsp;&nbsp;‚Ä¢ Ponderadores: ${processedData.adjustmentResult.ponderadores.length}<br>
            `;
                }

                return html;
            }

            generateTableHTML(data) {
                if (!data || data.length === 0) {
                    return '<p style="color: #666; font-style: italic;">No hay datos para mostrar</p>';
                }

                const newSheet = XLSX.utils.aoa_to_sheet(data);
                const sheetHTML = XLSX.utils.sheet_to_html(newSheet);
                return sheetHTML.replace('<table>', '<table class="excel-table">');
            }

            // ========================================
            // DESCARGA DE ARCHIVOS
            // ========================================

            downloadExcel() {
                if (!this.filteredData) {
                    alert('No hay datos para descargar');
                    return;
                }

                try {
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(this.filteredData);

                    XLSX.utils.book_append_sheet(wb, ws, 'Datos Procesados RCIS');

                    const fileName = this.generateFileName();
                    XLSX.writeFile(wb, fileName);

                    console.log('‚úÖ Archivo descargado:', fileName);
                } catch (error) {
                    alert('Error al generar el archivo: ' + error.message);
                    console.error('‚ùå Error en descarga:', error);
                }
            }

            generateFileName() {
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const baseFileName = this.originalFileName.replace(/\.[^/.]+$/, '') || 'rcis_datos';
                return `${baseFileName}_procesado_${timestamp}.xlsx`;
            }

            // ========================================
            // MANEJO DE UI
            // ========================================

            showError(message) {
                this.elements.errorContainer.innerHTML = `<div class="error">‚ùå ${message}</div>`;
                this.hideLoading();
                this.hideResults();
            }

            clearError() {
                this.elements.errorContainer.innerHTML = '';
            }

            showLoading() {
                this.clearError();
                this.elements.loading.style.display = 'block';
                this.hideResults();
                this.elements.downloadSection.style.display = 'none';
            }

            hideLoading() {
                this.elements.loading.style.display = 'none';
            }

            showResults() {
                this.elements.resultContainer.style.display = 'block';
                this.elements.downloadSection.style.display = 'block';
            }

            hideResults() {
                this.elements.resultContainer.style.display = 'none';
            }
        }

        // ============================================================================
        // INICIALIZACI√ìN
        // ============================================================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializando RCIS Processor...');
            new RCISProcessor();
            console.log('‚úÖ RCIS Processor inicializado correctamente');
        });
    </script>
</body>

</html>
